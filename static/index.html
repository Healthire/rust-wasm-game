<!DOCTYPE html>
<html lang="en">

<head>
    <title>Test</title>
</head>

<body class="container">
    <script src="websocket.js"></script>
    <script src="webgl.js"></script>
    <script>
        const Module = {};

        let HEAP8 = null;
        let HEAP16 = null;
        let HEAP32 = null;
        let HEAPU8 = null;
        let HEAPU16 = null;
        let HEAPU32 = null;
        let HEAPF32 = null;
        let HEAPF64 = null;

        function copyCStr(ptr) {
            let orig_ptr = ptr;
            const collectCString = function* () {
                while (HEAPU8[ptr] !== 0) {
                    if (HEAPU8[ptr] === undefined) { throw new Error("Tried to read undef mem") }
                    yield HEAPU8[ptr]
                    ptr += 1
                }
            }

            const buffer_as_u8 = new Uint8Array(collectCString())
            const utf8Decoder = new TextDecoder("UTF-8");
            const buffer_as_utf8 = utf8Decoder.decode(buffer_as_u8);
            return buffer_as_utf8
        }

        function newString(str) {
            const utf8Encoder = new TextEncoder("UTF-8");
            let string_buffer = utf8Encoder.encode(str)
            let len = string_buffer.length
            let ptr = Module.alloc_str(len + 1)

            for (i = 0; i < len; i++) {
                HEAPU8[ptr + i] = string_buffer[i]
            }
            HEAPU8[ptr + len] = 0;

            return ptr;
        }

        function fetchAndInstantiate(url, importObject) {
            return fetch(url).then(response =>
                response.arrayBuffer()
            ).then(bytes =>
                WebAssembly.instantiate(bytes, importObject)
                ).then(results =>
                    results.instance
                );
        }

        const imports = {
            env: {
                "__web_on_grow": function () {
                    const buffer = Module.instance.exports.memory.buffer;
                    HEAP8 = new Int8Array(buffer);
                    HEAP16 = new Int16Array(buffer);
                    HEAP32 = new Int32Array(buffer);
                    HEAPU8 = new Uint8Array(buffer);
                    HEAPU16 = new Uint16Array(buffer);
                    HEAPU32 = new Uint32Array(buffer);
                    HEAPF32 = new Float32Array(buffer);
                    HEAPF64 = new Float64Array(buffer);
                },
                js_websocket_create: websocket_create,
                js_websocket_send: websocket_send,
                js_websocket_onmessage: websocket_onmessage,
                js_websocket_onopen: websocket_onopen,
                js_websocket_close: websocket_close,

                js_gl_create_texture: gl_create_texture,
                js_gl_bind_texture: gl_bind_texture,
                js_gl_tex_parameter_i: gl_tex_parameter_i,
                js_gl_tex_image_2d: gl_tex_image_2d,
                js_gl_tex_sub_image_2d: gl_tex_sub_image_2d,
                js_gl_create_buffer: gl_create_buffer,
                js_gl_blend_func: gl_blend_func,
                js_gl_enable: gl_enable,
                js_gl_bind_buffer: gl_bind_buffer,
                js_gl_buffer_data: gl_buffer_data,
                js_gl_use_program: gl_use_program,
                js_gl_get_uniform_location: gl_get_uniform_location,
                js_gl_uniform2f: gl_uniform2f,
                js_gl_active_texture: gl_active_texture,
                js_gl_uniform1i: gl_uniform1i,
                js_gl_get_attrib_location: gl_get_attrib_location,
                js_gl_enable_vertex_attrib_array: gl_enable_vertex_attrib_array,
                js_gl_vertex_attrib_pointer: gl_vertex_attrib_pointer,
                js_gl_draw_arrays: gl_draw_arrays,
                js_gl_clear_color: gl_clear_color,
                js_gl_clear: gl_clear,
                js_gl_create_shader: gl_create_shader,
                js_gl_shader_source: gl_shader_source,
                js_gl_compile_shader: gl_compile_shader,
                js_gl_get_shader_parameter: gl_get_shader_parameter,
                js_gl_shader_info_log_len: gl_shader_info_log_len,
                js_gl_get_shader_info_log: gl_get_shader_info_log,
                js_gl_create_program: gl_create_program,
                js_gl_attach_shader: gl_attach_shader,
                js_gl_link_program: gl_link_program,
                js_gl_get_program_parameter: gl_get_program_parameter,
                js_gl_program_info_log_len: gl_program_info_log_len,
                js_gl_get_program_info_log: gl_get_program_info_log,

                js_gl_delete_texture: gl_delete_texture,
                js_gl_delete_shader: gl_delete_shader,
                js_gl_delete_buffer: gl_delete_buffer,
                js_gl_delete_program: gl_delete_program,
                js_gl_delete_uniform_location: gl_delete_uniform_location,

                sinf: function (n) { return Math.sin(n); },
                cosf: function (n) { return Math.cos(n); },
                fmodf: function (l, r) { return l % r; },
                js_console_log: function (str_ptr) {
                    var str = copyCStr(str_ptr);
                    console.log(str);
                },
                js_set_main_loop: function (fn_ptr) {
                    var f = Module.instance.exports.__web_table.get(fn_ptr);
                    function runner() {
                        f();
                        window.requestAnimationFrame(runner);
                    }
                    window.requestAnimationFrame(runner);

                    throw "SimulateInfiniteLoop"
                }
            }
        };

        window.addEventListener("load", function (event) {
            fetchAndInstantiate("client-web.wasm", imports)
                .then(mod => {
                    Module.alloc_str = mod.exports.alloc_str;
                    Module.dealloc_str = mod.exports.dealloc_str;
                    Module.memory = imports.env.memory;
                    Module.instance = mod;

                    Module.HEAP8 = HEAP8;
                    Module.HEAP16 = HEAP16;
                    Module.HEAP32 = HEAP32;
                    Module.HEAPU8 = HEAPU8;
                    Module.HEAPU16 = HEAPU16;
                    Module.HEAPU32 = HEAPU32;
                    Module.HEAPF32 = HEAPF32;
                    Module.HEAPF64 = HEAPF64;

                    console.log("Open webgl context")
                    gl.context = document.getElementById("window").getContext('webgl');
                    try {
                        mod.exports.__web_main()
                    } catch (e) {
                        if (e == "SimulateInfiniteLoop") {
                            return
                        } else {
                            throw e;
                        }
                    }
                });
        });
    </script>

    <div id="console">
        <canvas id="window" height="480" width="640" />
    </div>
</body>

</html>